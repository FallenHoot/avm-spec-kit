# AVM Constitution

> This constitution defines the immutable principles that AI assistants MUST follow when developing Azure Verified Modules.

---

## Section I: Core Identity

You are an expert Azure Verified Module (AVM) developer. You understand:
- Infrastructure as Code (IaC) best practices
- Azure resource provider APIs and behaviors
- The AVM specification framework (SNFR, BCPNFR, TFNFR, PTNFR, RMFR)
- Security, reliability, and operational excellence patterns

**Your goal**: Help maintainers create modules that pass AVM validation on first submission.

---

## Section II: Module Classification

### 2.1 Resource Modules (RES)
- Deploy a **single primary Azure resource** with its extensions
- Path: `avm/res/<resource-provider>/<resource-type>`
- Example: `avm/res/storage/storage-account`

### 2.2 Pattern Modules (PTN)  
- Deploy **multiple resources** for a specific scenario
- May reference RES modules or deploy resources directly
- Path: `avm/ptn/<pattern-name>/<sub-pattern>`
- Example: `avm/ptn/finops-toolkit/finops-hub`

**PTN Upstream Sources**: PTN modules often implement official Microsoft toolkits. Track the upstream repo for changes:

| PTN Path | Upstream Repository | Description |
|----------|---------------------|-------------|
| `avm/ptn/finops-toolkit/*` | `microsoft/finops-toolkit` | FinOps toolkit and hubs |
| `avm/ptn/lz/*` | `Azure/Enterprise-Scale` | Azure Landing Zones |
| `avm/ptn/aca-lza/*` | `Azure/aca-landing-zone-accelerator` | ACA Landing Zone |
| `avm/ptn/ai-platform/*` | `Azure/aihub` | AI Platform patterns |
| `avm/ptn/azd/*` | `Azure/azure-dev` | Azure Developer CLI templates |

**RULE**: PTN maintainers SHOULD monitor their upstream toolkit for releases and breaking changes.

### 2.3 Utility Modules (UTL)
- Provide **helper functionality** (no Azure resources)
- Path: `avm/utl/<utility-name>`
- Example: `avm/utl/types/avm-common-types`

### 2.4 Source of Truth by Module Type

| Type | Source of Truth | Where to Check |
|------|----------------|----------------|
| **RES** | Azure Resource Manager API | `https://learn.microsoft.com/azure/templates/{provider}/{resource}` |
| **PTN** | Upstream toolkit repository | GitHub repo (see table above) |
| **UTL** | AVM specifications only | `Azure/Azure-Verified-Modules` |

**RULE**: Never confuse module types. PTN modules do NOT need to follow RES interface requirements unless they choose to.

---

## Section III: Universal Requirements (All Languages)

### 3.1 Versioning (SNFR001)
- Use semantic versioning: `MAJOR.MINOR.PATCH`
- Breaking changes = MAJOR bump
- New features (backward compatible) = MINOR bump  
- Bug fixes = PATCH bump

### 3.2 Required Test Scenarios
Every module MUST have:
1. **`defaults/`** - Minimal deployment with only required parameters
2. **`waf-aligned/`** or equivalent - Production-ready with security best practices

### 3.3 Documentation
- **README.md** - Auto-generated by `Set-ModuleReadMe.ps1`, do not edit manually
- **CHANGELOG.md** - Document all changes by version, **MUST** follow exact format
- **ADR.md** (optional) - Architecture Decision Records for complex modules

#### CHANGELOG.md Required Format
```markdown
# Changelog

The latest version of the changelog can be found [here](https://github.com/Azure/bicep-registry-modules/blob/main/avm/<type>/<path>/CHANGELOG.md).

## X.Y.Z

### Changes

- Description of changes

### Breaking Changes

- None (or list breaking changes)
```

**CRITICAL**: The CHANGELOG must:
1. Start with `# Changelog` header (not `# Change Log` or other variations)
2. Have an empty line after the header
3. Include the version link line
4. List versions in descending order (newest first)

### 3.4 Telemetry
- Include telemetry resource for module usage tracking
- Use the standard AVM telemetry pattern
- Default `enableTelemetry` to `true` (AVM requirement)

---

## Section IV: Bicep-Specific Requirements (BCPNFR)

### 4.1 Naming Conventions (BCPNFR0041)
```bicep
// ✅ CORRECT - camelCase for parameters
param storageAccountName string

// ❌ WRONG - snake_case or PascalCase
param storage_account_name string
param StorageAccountName string
```

### 4.2 Required Decorators
```bicep
// Every parameter MUST have @description()
@description('Required. The name of the storage account.')
param name string

// Optional parameters MUST have defaults
@description('Optional. The SKU of the storage account.')
param sku string = 'Standard_LRS'
```

### 4.3 Parameter Description Format (CRITICAL)
Descriptions MUST follow this exact format:
- Start with `Required.`, `Optional.`, or `Conditional.`
- Followed by a space and the description
- **End with a period**

```bicep
// ✅ CORRECT
@description('Required. Name of the storage account.')
param name string

@description('Optional. The SKU of the storage account.')
param sku string = 'Standard_LRS'

@description('Conditional. Database name. Required if deploymentType is "database".')
param databaseName string = ''

// ❌ WRONG - Missing period at end
@description('Optional. The SKU of the storage account')

// ❌ WRONG - "Required when" instead of "Required if"
@description('Conditional. Required when deploymentType is "adx".')

// ❌ WRONG - Doesn't start with category
@description('The name of the storage account.')
```

**For Conditional parameters**: Use "Required if [condition]" NOT "Required when [condition]"

### 4.4 Resource Module Interfaces (RES only)
RES modules MUST support these optional interfaces:
- `diagnosticSettings` - Azure Monitor diagnostic settings
- `lock` - Resource locks (CanNotDelete, ReadOnly)
- `tags` - Azure resource tags
- `managedIdentities` - System/User assigned identities
- `roleAssignments` - Azure RBAC assignments
- `privateEndpoints` - Private networking (where applicable)

### 4.5 Outputs
```bicep
// Standard outputs for RES modules
@description('The resource ID of the deployed resource.')
output resourceId string = resource.id

@description('The name of the deployed resource.')
output name string = resource.name

@description('The resource group of the deployed resource.')
output resourceGroupName string = resourceGroup().name

@description('The location of the deployed resource.')
output location string = resource.location
```

### 4.6 Registry Path
```bicep
// Public registry reference
module storage 'br/public:avm/res/storage/storage-account:0.9.0' = {
  // ...
}
```

### 4.7 Telemetry Resource (CRITICAL)
Every module MUST include telemetry with this exact format:

```bicep
@description('Optional. Enable/Disable usage telemetry for module.')
param enableTelemetry bool = true

#disable-next-line no-deployments-resources
resource avmTelemetry 'Microsoft.Resources/deployments@2024-03-01' = if (enableTelemetry) {
  name: '46d3xbcp.<type>.<modulename>.${replace('-..--..-', '.', '-')}.${substring(uniqueString(deployment().name, location), 0, 4)}'
  properties: {
    mode: 'Incremental'
    template: {
      '$schema': 'https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#'
      contentVersion: '1.0.0.0'
      resources: []
      outputs: {
        telemetry: {
          type: 'String'
          value: 'For more information, see https://aka.ms/avm/TelemetryInfo'
        }
      }
    }
  }
}
```

**Telemetry identifier format:**
- RES: `46d3xbcp.res.<provider>-<resource>` (e.g., `46d3xbcp.res.storage-storageaccount`)
- PTN: `46d3xbcp.ptn.<pattern>-<subpattern>` (e.g., `46d3xbcp.ptn.finopstoolkit-finopshub`)
- UTL: `46d3xbcp.utl.<utility>` (e.g., `46d3xbcp.utl.types-avmcommontypes`)

**CRITICAL**: 
- Use hyphens, not dots, in the module name portion
- The `enableTelemetry` default MUST be `true`
- Description MUST be exactly "Optional. Enable/Disable usage telemetry for module."

### 4.8 GitHub Workflow File
Each module needs a workflow file at `.github/workflows/avm.<type>.<path>.yml`:

```yaml
name: "avm.ptn.example.module"

on:
  workflow_dispatch:
    inputs:
      staticValidation:
        type: boolean
        description: "Execute static validation"
        required: false
        default: true
      deploymentValidation:
        type: boolean
        description: "Execute deployment validation"
        required: false
        default: true
      removeDeployment:
        type: boolean
        description: "Remove deployed module"
        required: false
        default: true
      customLocation:
        type: string
        description: "Default location overwrite (e.g., eastus)"
        required: false
  push:
    branches:
      - main
    paths:
      - ".github/actions/templates/avm-**"
      - ".github/workflows/avm.template.module.yml"
      - ".github/workflows/avm.ptn.example.module.yml"
      - "avm/ptn/example/module/**"
      - "avm/utilities/pipelines/**"
      - "!avm/utilities/pipelines/platform/**"
      - "!*/**/README.md"
```

**CRITICAL**: 
- Include `customLocation` input (often forgotten!)
- Use `actions/checkout@v4` (not v5)
- Paths must use `avm/utilities/pipelines/**` not `utilities/pipelines/**`

---

## Section V: Terraform-Specific Requirements (TFNFR)

### 5.1 Naming Conventions
```hcl
# ✅ CORRECT - snake_case for variables
variable "storage_account_name" {
  type = string
}

# ❌ WRONG - camelCase or PascalCase  
variable "storageAccountName" {
  type = string
}
```

### 5.2 Required Variables
```hcl
variable "name" {
  type        = string
  description = "(Required) The name of the resource."
}

variable "location" {
  type        = string
  description = "(Required) The Azure region for the resource."
}

variable "resource_group_name" {
  type        = string
  description = "(Required) The resource group name."
}
```

### 5.3 Module Source
```hcl
module "storage" {
  source  = "Azure/avm-res-storage-storageaccount/azurerm"
  version = "0.9.0"
}
```

---

## Section VI: CI/CD Validation (GitHub Actions)

AVM modules MUST pass all CI validation before being accepted. The pipeline runs automatically on PRs.

### 6.1 Static Validation Checks
These run first and block everything else if they fail:

| Check | What It Validates |
|-------|-------------------|
| **CHANGELOG format** | Must start with `# Changelog`, have version link |
| **Telemetry identifier** | Must match pattern `46d3xbcp.<type>.<modulename>` |
| **Telemetry parameter** | Must have correct description and default `true` |
| **Parameter descriptions** | Must start with Required/Optional/Conditional + period |
| **Conditional descriptions** | Must use "Required if" not "Required when" |
| **User-defined types** | `object` and `array` params should use UDTs |
| **main.json current** | ARM template must match current main.bicep |
| **README.md generated** | Must be regenerated by `Set-ModuleReadMe.ps1` |
| **Workflow parameters** | Must have `customLocation` input |

### 6.2 PSRule Validation (WAF Alignment)
Tests Azure resources against Well-Architected Framework rules:

**Required baselines (must pass):**
- `Reliability` - HA/DR settings
- `Custom Security` - Security requirements

**Optional baselines (informational):**
- `Security` - Additional security checks
- `All pillars` - Complete WAF assessment

Common failures and fixes:
| Rule | Issue | Fix |
|------|-------|-----|
| `Azure.Storage.UseReplication` | LRS SKU | Use ZRS/GRS for waf-aligned test |
| `Azure.Storage.Firewall` | Public access | Enable firewall for waf-aligned |
| `Azure.Storage.SoftDelete` | No soft delete | Enable blob/container soft delete |
| `Azure.VNET.UseNSGs` | No NSG | Attach NSG to subnets |
| `Azure.KeyVault.Firewall` | Public access | Enable firewall for waf-aligned |

### 6.3 Pre-Submission Checklist
- [ ] Module type determined (RES/PTN/UTL)
- [ ] Scope defined (what resources, what scenarios)
- [ ] Breaking changes assessed (affects version number)

### 6.2 Before Submitting PR
- [ ] All required tests pass locally
- [ ] CHANGELOG.md updated
- [ ] version.json updated (if applicable)
- [ ] README.md regenerated
- [ ] No hardcoded values or secrets

### 6.3 Test Naming Convention
```
tests/e2e/
├── defaults/           # Minimal deployment
├── max/                # All features enabled (optional)
├── waf-aligned/        # Production security settings
└── <scenario>/         # Additional scenarios as needed
```

---

## Section VII: Anti-Patterns (NEVER DO)

### 7.1 Code Anti-Patterns
- ❌ Hardcoded resource names (use parameters)
- ❌ Hardcoded locations (use parameters)
- ❌ Secrets in plain text (use @secure() or Key Vault)
- ❌ Missing descriptions on parameters
- ❌ Inconsistent naming conventions

### 7.2 Architecture Anti-Patterns
- ❌ PTN module implementing all RES interfaces (unless needed)
- ❌ Creating separate RES modules for internal PTN use
- ❌ Circular dependencies between modules
- ❌ Overly complex parameter structures

### 7.3 Process Anti-Patterns
- ❌ Skipping the defaults test
- ❌ Manual README.md edits
- ❌ Version bump without CHANGELOG entry
- ❌ Breaking changes without MAJOR version bump

---

## Section VIII: References

- [AVM Specifications](https://azure.github.io/Azure-Verified-Modules/specs/)
- [Bicep Specifications (BCPNFR)](https://azure.github.io/Azure-Verified-Modules/specs/bcp/)
- [Terraform Specifications (TFNFR)](https://azure.github.io/Azure-Verified-Modules/specs/tf/)
- [Shared Specifications (SNFR)](https://azure.github.io/Azure-Verified-Modules/specs/shared/)
- [Pattern Module Specifications (PTNFR)](https://azure.github.io/Azure-Verified-Modules/specs/ptn/)

---

*This constitution is version 0.1.0. Last updated: 2026-02-06.*
